{% extends "base.html" %}

{% block title %}Categories - Green Harvest{% endblock %}

{% block content %}
<section class="section">
    <div class="container">
        <div class="page-header">
            <h1>
                {% if search_query %}
                Search Results for "{{ search_query }}"
                {% elif current_category %}
                {{ current_category.name }}
                {% else %}
                All Products
                {% endif %}
            </h1>
            <p>
                {% if search_query %}
                Found {{ products|length }} product(s) matching your search
                {% else %}
                Browse our wide range of organic products
                {% endif %}
            </p>
        </div>

        <div class="categories-wrapper">
            <!-- Left Sidebar Filters -->
            <aside class="filters-sidebar">
                <!-- Category Filter -->
                <div class="filter-group">
                    <h3 class="filter-title">
                        <i class="fas fa-list"></i> Categories
                    </h3>
                    <div class="filter-options">
                        <a href="{{ url_for('categories') }}"
                            class="filter-option {% if not current_category %}active{% endif %}">
                            <span>All Products</span>
                        </a>
                        {% for category in categories %}
                        <a href="{{ url_for('categories', category=category._id) }}"
                            class="filter-option {% if current_category and current_category._id == category._id %}active{% endif %}">
                            <span>{{ category.name }} ({{ category.product_count }})</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>

                <!-- Price Filter -->
                <div class="filter-group">
                    <h3 class="filter-title">
                        <i class="fas fa-tag"></i> Price
                    </h3>
                    <div class="filter-options">
                        <a href="{{ url_for('categories', category=current_category.id if current_category else '', search=search_query, sort='low_to_high') }}"
                            class="filter-option {% if request.args.get('sort') == 'low_to_high' %}active{% endif %}">
                            <i class="fas fa-arrow-up"></i>
                            <span>Low to High</span>
                        </a>
                        <a href="{{ url_for('categories', category=current_category.id if current_category else '', search=search_query, sort='high_to_low') }}"
                            class="filter-option {% if request.args.get('sort') == 'high_to_low' %}active{% endif %}">
                            <i class="fas fa-arrow-down"></i>
                            <span>High to Low</span>
                        </a>
                    </div>

                    <!-- Single Price Range Slider -->
                    <div class="price-range-filter">
                        <label for="price_range">Price up to: ₹<span id="price_range_value">{{ request.args.get('price_max', max_price) }}</span></label>
                        <input type="range" id="price_range_max" min="0" max="{{ max_price }}" step="1" value="{{ request.args.get('price_max', max_price) }}" oninput="updatePriceRange()">
                        <button class="btn-apply-price" onclick="applyPriceRangeSlider()">Apply</button>
                    </div>
                {% block scripts %}
                <script>
                function updatePriceRange() {
                    const max = document.getElementById('price_range_max').value;
                    document.getElementById('price_range_value').textContent = `${max}`;
                }

                function applyPriceRangeSlider() {
                    const max = document.getElementById('price_range_max').value;
                    const url = new URL(window.location.href);
                    url.searchParams.set('price_min', 0);
                    url.searchParams.set('price_max', max);
                    window.location.href = url.toString();
                }
                </script>
                {% endblock %}
                </div>
            </aside>

            <!-- Main Content Area -->
            <div class="products-area">
                {% if products %}
                <div class="products-grid">
                    {% for product in products %}
                    <div class="product-card">
                        <a href="{{ url_for('product_detail', product_id=product.id) }}">
                            <div class="product-image">
                                {% if product.image %}
                                {% set fallback_img = product.image_url if product.image_url else url_for('static', filename='images/placeholder.jpg') %}
                                <img src="{{ url_for('static', filename='images/' + product.image) }}"
                                    alt="{{ product.name }}"
                                    onerror="this.src='{{ fallback_img }}'">
                                {% elif product.image_url %}
                                <img src="{{ product.image_url }}"
                                    alt="{{ product.name }}">
                                {% else %}
                                <img src="{{ url_for('static', filename='images/placeholder.jpg') }}"
                                    alt="{{ product.name }}">
                                {% endif %}
                                <span class="badge-organic">Organic</span>
                            </div>
                        </a>

                        <div class="product-info">
                            <div class="product-header">
                                <h3><a href="{{ url_for('product_detail', product_id=product.id) }}">{{ product.name }}</a>
                                </h3>
                                  <span class="price">₹{{ "{:,}".format(product.price|int) }}</span>
                            </div>
                            <p class="product-category">{{ product.category_name }}</p>
                            <div class="product-footer">
                                {% if not current_user.is_admin %}
                                <div class="product-actions">
                                    <button class="btn-icon add-to-wishlist" data-product-id="{{ product._id }}"
                                        title="Add to Wishlist">
                                        <i class="{% if product.in_wishlist %}fas{% else %}far{% endif %} fa-heart"></i>
                                    </button>
                                    <div class="cart-action" data-product-id="{{ product.id }}">
                                        {% if cart_quantities.get(product.id) %}
                                        <div class="qty-control" data-product-id="{{ product.id }}">
                                            <button type="button" class="qty-btn" data-action="decrement"
                                                aria-label="Decrease quantity">-</button>
                                            <span class="qty-value">{{ cart_quantities[product.id] }}</span>
                                            <button type="button" class="qty-btn" data-action="increment"
                                                aria-label="Increase quantity">+</button>
                                        </div>
                                        {% else %}
                                        <button type="button" class="btn-add-cart quick-add"
                                            data-product-id="{{ product.id }}" title="Add to Cart">
                                            <i class="fas fa-shopping-bag"></i>
                                            <span>Add to Cart</span>
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <!-- Pagination Controls -->
                {% if total_pages > 1 %}
                <nav class="pagination-nav">
                  <ul class="pagination">
                    {% if page > 1 %}
                      <li><a href="{{ url_for('categories', page=page-1, category=request.args.get('category'), search=search_query, sort=request.args.get('sort'), price_min=request.args.get('price_min'), price_max=request.args.get('price_max')) }}">&laquo; Prev</a></li>
                    {% endif %}
                    {% for p in range(1, total_pages+1) %}
                      <li {% if p == page %}class="active"{% endif %}><a href="{{ url_for('categories', page=p, category=request.args.get('category'), search=search_query, sort=request.args.get('sort'), price_min=request.args.get('price_min'), price_max=request.args.get('price_max')) }}">{{ p }}</a></li>
                    {% endfor %}
                    {% if page < total_pages %}
                      <li><a href="{{ url_for('categories', page=page+1, category=request.args.get('category'), search=search_query, sort=request.args.get('sort'), price_min=request.args.get('price_min'), price_max=request.args.get('price_max')) }}">Next &raquo;</a></li>
                    {% endif %}
                  </ul>
                </nav>
                {% endif %}
                <!-- End Pagination Controls -->
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-box-open"></i>
                    <h3>No products found in this price range</h3>
                    <p>
                        {% if search_query %}
                        No products match your search "{{ search_query }}" in this price range. Try different keywords or adjust the range.
                        {% else %}
                        We couldn't find any products in this price range.
                        {% endif %}
                    </p>
                    <a href="{{ url_for('categories') }}" class="btn btn-primary">View All Products</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>
{% endblock %}